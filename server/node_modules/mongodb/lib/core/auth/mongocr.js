'use strict';

const crypto = require('crypto');
const AuthProvider = require('./auth_provider').AuthProvider;

<<<<<<< HEAD
class MongoCR extends AuthProvider {
  auth(authContext, callback) {
    const connection = authContext.connection;
    const credentials = authContext.credentials;
=======
/**
 * Creates a new MongoCR authentication mechanism
 *
 * @extends AuthProvider
 */
class MongoCR extends AuthProvider {
  /**
   * Implementation of authentication for a single connection
   * @override
   */
  _authenticateSingleConnection(sendAuthCommand, connection, credentials, callback) {
>>>>>>> 294d75090c0670d1606c5984e2bdb3ac5fc7c2c2
    const username = credentials.username;
    const password = credentials.password;
    const source = credentials.source;

<<<<<<< HEAD
    connection.command(`${source}.$cmd`, { getnonce: 1 }, (err, result) => {
=======
    sendAuthCommand(connection, `${source}.$cmd`, { getnonce: 1 }, (err, r) => {
>>>>>>> 294d75090c0670d1606c5984e2bdb3ac5fc7c2c2
      let nonce = null;
      let key = null;

      // Get nonce
      if (err == null) {
<<<<<<< HEAD
        const r = result.result;
=======
>>>>>>> 294d75090c0670d1606c5984e2bdb3ac5fc7c2c2
        nonce = r.nonce;
        // Use node md5 generator
        let md5 = crypto.createHash('md5');
        // Generate keys used for authentication
        md5.update(username + ':mongo:' + password, 'utf8');
        const hash_password = md5.digest('hex');
        // Final key
        md5 = crypto.createHash('md5');
        md5.update(nonce + username + hash_password, 'utf8');
        key = md5.digest('hex');
      }

      const authenticateCommand = {
        authenticate: 1,
        user: username,
        nonce,
        key
      };

<<<<<<< HEAD
      connection.command(`${source}.$cmd`, authenticateCommand, callback);
=======
      sendAuthCommand(connection, `${source}.$cmd`, authenticateCommand, callback);
>>>>>>> 294d75090c0670d1606c5984e2bdb3ac5fc7c2c2
    });
  }
}

module.exports = MongoCR;
